<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    body { background: #f4f7f9; display: flex; justify-content: center; align-items: flex-start; padding: 24px 12px; }
    .app { width: 100%; max-width: 420px; background: #fff; border-radius: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); overflow: hidden; }
    .header { background: #0b2c6a; color: #fff; padding: 16px; display: flex; align-items: center; gap: 12px; }
    .avatar { width: 40px; height: 40px; border-radius: 8px; background: #e5eefc; overflow: hidden; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .title { flex: 1; }
    .title .name { font-weight: 600; }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; margin-top: 6px; }
    .badge.ongoing { background: #eaf7ed; color: #1f7a2e; }
    .badge.expired { background: #fdeaea; color: #b42727; }
    .badge.completed { background: #eaf1fd; color: #2c5ac7; }
    .badge.hidden { display: none; }
    .content { padding: 12px; }
    .controls { display: none; }
    select, input { flex: 1; padding: 10px 12px; border-radius: 8px; border: 1px solid #ccd3e0; font-size: 14px; }
    input:focus, select:focus { outline: none; border-color: #4a90e2; box-shadow: 0 0 4px rgba(74,144,226,.6); }
    .chat { background: #f7f8fb; border: 1px solid #e3e7ef; min-height: 320px; max-height: 60vh; border-radius: 12px; padding: 12px; overflow-y: auto; }
    .bubble { max-width: 85%; border-radius: 12px; padding: 10px 12px; margin: 8px 0; font-size: 14px; line-height: 1.5; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .bubble.user { margin-left: auto; background: #eaf1ff; color: #193b7a; }
    .bubble.bot { background: #fff; border: 1px solid #e4e8f2; }
    .typing { display: inline-flex; align-items: center; gap: 6px; }
    .typing .dot { width: 6px; height: 6px; background: #c6d0ea; border-radius: 50%; animation: dotPulse 1.2s infinite ease-in-out; }
    .typing .dot:nth-child(2) { animation-delay: 0.2s; }
    .typing .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dotPulse { 0% { opacity: 0.2; transform: translateY(0); } 50% { opacity: 1; transform: translateY(-3px); } 100% { opacity: 0.2; transform: translateY(0); } }
    .suggest { display: flex; gap: 8px; margin-top: 10px; }
    .suggest button { flex: 1; background: #eef2fa; color: #1b2a4a; border: 1px solid #dbe1f0; border-radius: 12px; padding: 10px; font-size: 14px; }
    .inputRow { display: flex; gap: 8px; margin-top: 10px; }
    .send { padding: 10px 16px; background: #4a90e2; color: #fff; border: none; border-radius: 8px; }
    .footer { text-align: center; color: #6a7692; font-size: 13px; padding: 12px; }
    .hidden { display: none; }
    .bubble.bot ul { margin: 6px 0 0 18px; padding: 0; }
    .bubble.bot li { margin: 6px 0; }
    .optionsBubble .title { font-weight: 600; margin-bottom: 8px; }
    .optionBtn { width: 100%; text-align: left; background: #eef2fa; color: #1b2a4a; border: 1px solid #dbe1f0; border-radius: 16px; padding: 12px 14px; margin: 8px 0; font-size: 14px; }
    .chip { display: inline-block; padding: 6px 10px; border-radius: 999px; font-size: 12px; }
    .offersList { display: flex; flex-direction: column; gap: 12px; margin-bottom: 12px; }
    .offerItem { display: flex; align-items: center; gap: 12px; background: #f7f8fb; border: 1px solid #e3e7ef; border-radius: 16px; padding: 10px 12px; }
    .offerItem.selected { border-color: #4a90e2; box-shadow: 0 0 0 2px rgba(74,144,226,.15); }
    .offerItem .icon { width: 44px; height: 44px; border-radius: 10px; overflow: hidden; background: #e5eefc; }
    .offerItem .icon img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .offerItem .titleTxt { flex: 1; font-weight: 600; color: #1b2a4a; }
    .chip.ongoing { background: #ffefb3; color: #7a5c00; }
    .chip.expired { background: #ffd7d7; color: #8a1d1d; }
    .chip.completed { background: #c4f2ce; color: #0e6a2a; }
    .videoOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .videoOverlay.show { display: flex; }
    .videoBox { width: 100%; max-width: 420px; background: #000; border-radius: 12px; padding: 8px; }
    .videoBox video { width: 100%; height: auto; border-radius: 8px; display: block; }
    .videoActions { display: flex; justify-content: flex-end; margin-top: 8px; }
  </style>
</head>
<body>

  <div class="app">
    <div class="header">
      <div class="avatar"><img id="offerIcon" alt="Offer icon"></div>
      <div class="title">
        <div class="name" id="offerName">Support</div>
        <div class="badge hidden" id="offerBadge"></div>
      </div>
    </div>
    <div class="content">
      <div class="controls">
        <select id="offer">
          <option value="">Select Offer</option>
          <option value="925599">WoodBlock Puzzle Game</option>
          <option value="111222">Sea Block</option>
          <option value="333444">Carrom Pool: Disc Game</option>
        </select>
      </div>
      <div id="offersList" class="offersList"></div>
      <div class="chat" id="chatLog"></div>
      <div class="suggest hidden" id="suggestRow">
        <button id="btnNotAble">I'm not able to complete the offer</button>
      </div>
      <div class="inputRow hidden" id="inputRow">
        <input id="msg" placeholder="Type your query" />
        <button class="send" id="sendBtn">Send</button>
      </div>
    </div>
    <div class="footer hidden" id="footerText">Select an option above to continue</div>
  </div>
  <div id="videoOverlay" class="videoOverlay">
    <div class="videoBox">
      <video id="guideVideo" controls playsinline preload="metadata"></video>
      <div class="videoActions">
        <button class="send" id="closeVideoBtn">Close</button>
      </div>
    </div>
  </div>

  <script>
    let ws;
    const chatLog = document.getElementById("chatLog");
    const msgInput = document.getElementById("msg");
    const sendBtn = document.getElementById("sendBtn");
    const inputRow = document.getElementById("inputRow");
    const offerSelect = document.getElementById("offer");
    const offerName = document.getElementById("offerName");
    const offerBadge = document.getElementById("offerBadge");
    const offerIcon = document.getElementById("offerIcon");
    const btnNotAble = document.getElementById("btnNotAble");
    const suggestRow = document.getElementById("suggestRow");
    const footerText = document.getElementById("footerText");
    let typingEl = null;
    let currentBotBubble = null;
    const statusById = { "925599": "Completed", "111222": "Ongoing", "333444": "Expired" };
    const badgeClassByStatus = { "Completed": "completed", "Ongoing": "ongoing", "Expired": "expired" };
    const iconById = { "925599": "icons/woodblock.png", "111222": "icons/aquastar.png", "333444": "icons/carrom.png" };
    const offersList = document.getElementById("offersList");
    const videoOverlay = document.getElementById("videoOverlay");
    const guideVideo = document.getElementById("guideVideo");
    const closeVideoBtn = document.getElementById("closeVideoBtn");
    const guideById = { "925599": "videos/tutorial.mp4", "111222": "videos/tutorial.mp4", "333444": "videos/tutorial.mp4" };

    function setOfferFromData({ offerId, offerName, offerIconUrl, status }) {
      if (!offerId) return;
      const label = offerName || "Support";
      statusById[offerId] = status || "Ongoing";
      if (offerIconUrl) iconById[offerId] = offerIconUrl;
      offerSelect.innerHTML = `<option value="">Select Offer</option><option value="${offerId}">${label}</option>`;
      offerName.textContent = label;
      updateOfferIcon(offerId, label);
      offerSelect.value = offerId;
      renderOffersList();
      offerSelect.dispatchEvent(new Event("change"));
    }
    function applyOfferFromParams() {
      const qp = new URLSearchParams(location.search);
      const offerId = qp.get("offerId");
      const offerName = qp.get("offerName");
      const offerIconUrl = qp.get("offerIconUrl");
      const status = qp.get("status") || "Ongoing";
      if (!offerId) return;
      setOfferFromData({ offerId, offerName, offerIconUrl, status });
    }
    window.addEventListener("popstate", applyOfferFromParams);
    window.addEventListener("hashchange", applyOfferFromParams);
    window.addEventListener("message", (e) => {
      const d = e.data;
      if (d && d.type === "setOffer" && d.payload) setOfferFromData(d.payload);
    });

    function placeholderIcon(title) {
      const letter = (title || "S").trim().charAt(0).toUpperCase() || "S";
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><rect width='100%' height='100%' fill='#e5eefc'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-size='18' fill='#193b7a' font-family='Segoe UI, Roboto, Arial'>${letter}</text></svg>`;
      return "data:image/svg+xml;utf8," + encodeURIComponent(svg);
    }

    function updateOfferIcon(id, title) {
      const src = iconById[id] || placeholderIcon(title);
      offerIcon.src = src;
      offerIcon.onerror = () => { offerIcon.src = placeholderIcon(title); };
    }

    function addBubble(text, who) {
      const b = document.createElement("div");
      b.className = "bubble " + who;
      b.textContent = text;
      chatLog.appendChild(b);
      chatLog.scrollTop = chatLog.scrollHeight;
      return b;
    }
    function addBubbleHTML(html, who) {
      const b = document.createElement("div");
      b.className = "bubble " + who;
      b.innerHTML = html;
      chatLog.appendChild(b);
      chatLog.scrollTop = chatLog.scrollHeight;
      return b;
    }
    function showTypingIndicator() {
      if (typingEl) return;
      if (!currentBotBubble) return;
      typingEl = document.createElement("span");
      typingEl.className = "typing";
      typingEl.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      currentBotBubble.appendChild(typingEl);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
    function hideTypingIndicator() {
      if (typingEl) { typingEl.remove(); typingEl = null; }
    }

    function connect() {
      const PROD_WS_HOST = "support-chatbot-1.onrender.com";
      const isHttps = location.protocol === "https:";
      const host = isHttps ? PROD_WS_HOST : "10.0.2.2:8000";
      const url = (isHttps ? "wss://" : "ws://") + host + "/ws";
      ws = new WebSocket(url);
      ws.onopen = () => {};
      ws.onmessage = (event) => {
        if (!currentBotBubble) currentBotBubble = addBubble("", "bot");
        if (event.data === "\n\n") {
          hideTypingIndicator();
          currentBotBubble = null;
          return;
        }
        hideTypingIndicator();
        currentBotBubble.textContent += event.data;
        chatLog.scrollTop = chatLog.scrollHeight;
      };
      ws.onclose = () => { setTimeout(connect, 3000); };
      ws.onerror = () => { addBubble("Error: Connection lost.", "bot"); };
    }
    // In decision-tree-only (lite) phase, avoid auto-connecting WebSocket.
    // Uncomment the next line when enabling typed chat again.
    // connect();
    offerIcon.src = placeholderIcon("Support");
    applyOfferFromParams();
    renderOffersList();

    offerSelect.addEventListener("change", () => {
      chatLog.innerHTML = "";
      msgInput.value = "";
      inputRow.classList.add("hidden");
      suggestRow.classList.add("hidden");
      footerText.classList.add("hidden");
      hideTypingIndicator();
      const title = offerSelect.options[offerSelect.selectedIndex]?.text || "Support";
      offerName.textContent = title;
      updateOfferIcon(offerSelect.value, title);
      if (!offerSelect.value) {
        offerBadge.textContent = "";
        offerBadge.className = "badge hidden";
      } else {
        const status = statusById[offerSelect.value] || "Ongoing";
        offerBadge.textContent = status;
        offerBadge.className = "badge " + (badgeClassByStatus[status] || "ongoing");
        // Suggestions are rendered inside chat bubbles; keep external row hidden
        // Default guided messages per status
        if (status === "Ongoing") {
          addBubble("I see that you've started this offer! üéØ", "bot");
          addBubble("Advertisers typically take 24‚Äì48 hours to verify your task and process rewards. Please continue using the app/game for 20‚Äì30 minutes. üéÆ", "bot");
        } else if (status === "Completed") {
          addBubble("Your offer is already completed. Please check your wallet.", "bot");
          addBubble("You can explore other available offers.", "bot");
        } else if (status === "Expired") {
          addBubble("This offer has expired.", "bot");
          addBubble("You can try other available offers.", "bot");
        }
        // Set options per status
        setOptionsForStatus(status);
      }
      updateFooterVisibility();
      highlightSelectedOffer();
    });

    function updateFooterVisibility() { footerText.classList.add("hidden"); }

    let currentOptionsContainer = null;
    function setSuggestions(items, title = "What would you like to know?") {
      if (currentOptionsContainer) { currentOptionsContainer.remove(); currentOptionsContainer = null; }
      if (!items || items.length === 0) { updateFooterVisibility(); return; }
      const wrap = document.createElement("div");
      wrap.className = "optionsBubble";
      const inner = document.createElement("div");
      inner.className = "bubble bot";
      const heading = document.createElement("div");
      heading.className = "title";
      heading.textContent = title;
      inner.appendChild(heading);
      items.forEach(({ text, onClick }) => {
        const btn = document.createElement("button");
        btn.className = "optionBtn";
        btn.textContent = text;
        btn.onclick = () => { addBubble(text, "user"); onClick(); inner.remove(); currentOptionsContainer = null; };
        inner.appendChild(btn);
      });
      wrap.appendChild(inner);
      chatLog.appendChild(wrap);
      chatLog.scrollTop = chatLog.scrollHeight;
      currentOptionsContainer = wrap;
      updateFooterVisibility();
    }

    function showHelpOptions() {
      addBubble("Let‚Äôs get you back on track. Choose an option:", "bot");
      setSuggestions([
        { text: "Watch 2‚Äëmin guide", onClick: showWatchGuide },
        { text: "View step‚Äëby‚Äëstep instructions", onClick: showStepByStep }
      ]);
    }

    function showWatchGuide() {
      addBubble("Watch a short guide to complete the offer üéØ", "bot");
      const btn = document.createElement("button");
      btn.className = "send";
      btn.textContent = "Watch now";
      btn.onclick = () => {
        const current = offerSelect.value;
        const src = guideById[current] || "videos/walkthrough.mp4";
        openGuideVideo(src);
      };
      const holder = document.createElement("div");
      holder.style.marginTop = "8px";
      holder.appendChild(btn);
      chatLog.appendChild(holder);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function showStepByStep() {
      addBubble("Step‚Äëby‚Äëstep Instructions:", "bot");
      addBubbleHTML("<ul><li>Install the app</li><li>Use for 10+ minutes ‚è≥</li><li>Sign up with valid details üìù</li><li>Don‚Äôt uninstall üö´</li></ul>", "bot");
      setSuggestions([
        { text: "Check out other available offers", onClick: showBrowseOffers },
        { text: "Report this issue to us", onClick: showReportIssue }
      ]);
    }

    function renderOffersList() {
      offersList.innerHTML = "";
      Array.from(offerSelect.options).forEach(o => {
        if (!o.value) return;
        const item = document.createElement("div");
        item.className = "offerItem";
        const iconWrap = document.createElement("div");
        iconWrap.className = "icon";
        const img = document.createElement("img");
        img.src = iconById[o.value] || placeholderIcon(o.text);
        img.onerror = () => { img.src = placeholderIcon(o.text); };
        iconWrap.appendChild(img);
        const title = document.createElement("div");
        title.className = "titleTxt";
        title.textContent = o.text;
        const status = statusById[o.value] || "Ongoing";
        const chip = document.createElement("div");
        chip.className = "chip " + (badgeClassByStatus[status] || "ongoing");
        chip.textContent = status;
        item.appendChild(iconWrap);
        item.appendChild(title);
        item.appendChild(chip);
        item.onclick = () => {
          offerSelect.value = o.value;
          offerSelect.dispatchEvent(new Event("change"));
        };
        offersList.appendChild(item);
      });
      highlightSelectedOffer();
    }
    function highlightSelectedOffer() {
      Array.from(offersList.children).forEach(child => child.classList.remove("selected"));
      const val = offerSelect.value;
      if (!val) return;
      const idx = Array.from(offerSelect.options).findIndex(o => o.value === val);
      if (idx > -1) {
        const el = offersList.children[idx - 1]; // skip the first 'Select Offer' option
        if (el) el.classList.add("selected");
      }
    }
    function showBrowseOffers() {
      addBubble("Here are new offers üéâ Click to get started:", "bot");
      const current = offerSelect.value;
      const options = Array.from(offerSelect.options)
        .filter(o => o.value && o.value !== current)
        .slice(0, 2);
      setSuggestions(options.map(o => ({
        text: o.text,
        onClick: () => {
          offerSelect.value = o.value;
          offerSelect.dispatchEvent(new Event("change"));
          addBubble("Happy earning üí∞üöÄ", "bot");
          setSuggestions([]);
        }
      })));
    }

    function showReportIssue() {
      const title = offerSelect.options[offerSelect.selectedIndex]?.text || "Offer";
      const offerId = offerSelect.value || "";
      const subject = encodeURIComponent(`Issue with offer ${title}${offerId ? ` (${offerId})` : ""}`);
      const body = encodeURIComponent("Describe your issue briefly, including screenshots if possible.");
      const mailto = `mailto:support@greedygame.com?subject=${subject}&body=${body}`;
      addBubble("Redirecting to support@greedygame.com for assistance.", "bot");
      const link = document.createElement("a");
      link.href = mailto;
      link.textContent = "Open email";
      link.className = "send";
      link.target = "_blank";
      const holder = document.createElement("div");
      holder.style.marginTop = "8px";
      holder.appendChild(link);
      chatLog.appendChild(holder);
      chatLog.scrollTop = chatLog.scrollHeight;
      window.location.href = mailto;
      setSuggestions([
        { text: "Try other available offers", onClick: showBrowseOffers },
        { text: "End Chat", onClick: endChat }
      ]);
    }

    function endChat() {
      addBubble("Thanks for chatting üëã Happy earning üí∞üöÄ", "bot");
      setSuggestions([]);
      inputRow.classList.add("hidden");
      try {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ event: "end_chat" }));
        }
      } catch (e) {}
    }
    function getMimeType(src) {
      const ext = (src.split(".").pop() || "").toLowerCase();
      if (ext === "mp4") return "video/mp4";
      if (ext === "webm") return "video/webm";
      if (ext === "mov") return "video/quicktime";
      return "video/mp4";
    }
    function openGuideVideo(src) {
      guideVideo.innerHTML = "";
      const source = document.createElement("source");
      source.src = src;
      source.type = getMimeType(src);
      guideVideo.appendChild(source);
      videoOverlay.classList.add("show");
      guideVideo.load();
      guideVideo.onloadedmetadata = () => {
        guideVideo.play().catch(() => {});
      };
      guideVideo.onerror = () => {
        closeGuideVideo();
        addBubble("Unable to load video. Opening in a new tab‚Ä¶", "bot");
        try { window.open(src, "_blank"); } catch (e) {}
      };
      guideVideo.onended = () => {
        closeGuideVideo();
        addBubble("Happy earning üí∞üöÄ", "bot");
        setSuggestions([]);
      };
    }
    function closeGuideVideo() {
      guideVideo.pause();
      guideVideo.currentTime = 0;
      guideVideo.innerHTML = "";
      videoOverlay.classList.remove("show");
    }
    closeVideoBtn.onclick = closeGuideVideo;

    function setOptionsForStatus(status) {
      if (status === "Ongoing") {
        setSuggestions([
          { text: "I'm not able to complete the offer", onClick: showHelpOptions }
        ]);
      } else if (status === "Completed") {
        setSuggestions([
          { text: "Check out other available offers", onClick: showBrowseOffers }
        ]);
      } else if (status === "Expired") {
        setSuggestions([
          { text: "Check out other available offers", onClick: showBrowseOffers }
        ]);
      }
    }
    // Initialize with hidden (no offer selected); options appear after selection via setOptionsForStatus()
    sendBtn.addEventListener("click", send);
    msgInput.addEventListener("keydown", (e) => { if (e.key === "Enter") send(); });

    function send() {
      const msg = msgInput.value.trim();
      const offer = offerSelect.value;
      if (!msg) return;
      addBubble(msg, "user");
      currentBotBubble = addBubble("", "bot");
      showTypingIndicator();
      msgInput.value = "";
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ message: msg, offer_id: offer }));
      } else {
        addBubble("Error: No connection.", "bot");
      }
    }
  </script>

</body>
</html>
