<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    body { background: #0f1424; display: flex; justify-content: center; align-items: flex-start; padding: 24px 12px; color: #e6edf7; }
    .app { width: 100%; max-width: 440px; background: transparent; border-radius: 22px; overflow: hidden; }
  .header { background: linear-gradient(135deg, #0d1426 0%, #1a2740 100%); color: #fff; padding: calc(env(safe-area-inset-top, 0px) + 16px) 20px 20px; display: flex; align-items: center; gap: 12px; }
    .avatar { width: 40px; height: 40px; border-radius: 8px; background: #1b2438; overflow: hidden; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .title { flex: 1; }
    .title .name { font-weight: 600; }
    .badge { display: inline-block; padding: 6px 10px; border-radius: 999px; font-size: 12px; margin-top: 8px; background: rgba(255,255,255,0.08); }
    .badge.ongoing { background: #ffefb3; color: #7a5c00; }
    .badge.expired { background: #fdeaea; color: #b42727; }
    .badge.completed { background: #eaf1fd; color: #2c5ac7; }
    .badge.hidden { display: none; }
    .content { padding: 14px; }
    .controls { display: none; }
    select, input { flex: 1; padding: 10px 12px; border-radius: 8px; border: 1px solid #34415f; background: #0f1424; color: #e6edf7; font-size: 14px; }
    input:focus, select:focus { outline: none; border-color: #4a90e2; box-shadow: 0 0 4px rgba(74,144,226,.4); }
    .chat { background: #12192b; border: 1px solid #253047; min-height: 360px; max-height: 62vh; border-radius: 14px; padding: 12px; overflow-y: auto; }
    .bubble { max-width: 85%; border-radius: 14px; padding: 12px 14px; margin: 8px 0; font-size: 15px; line-height: 1.55; box-shadow: none; color: #e6edf7; }
    .bubble.user { margin-left: auto; background: #2a3856; color: #dbe6ff; }
    .bubble.bot { background: #26334d; border: 1px solid #34415f; }
    .typing { display: inline-flex; align-items: center; gap: 6px; }
    .typing .dot { width: 6px; height: 6px; background: #8fa2cf; border-radius: 50%; animation: dotPulse 1.2s infinite ease-in-out; }
    .typing .dot:nth-child(2) { animation-delay: 0.2s; }
    .typing .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dotPulse { 0% { opacity: 0.2; transform: translateY(0); } 50% { opacity: 1; transform: translateY(-3px); } 100% { opacity: 0.2; transform: translateY(0); } }
    .suggest { display: flex; gap: 8px; margin-top: 10px; }
    .suggest button { flex: 1; background: #2a3856; color: #dbe6ff; border: 1px solid #34415f; border-radius: 12px; padding: 10px; font-size: 14px; transition: background .15s ease, box-shadow .15s ease; }
    .suggest button:hover { background: #334466; box-shadow: 0 0 0 2px rgba(74,144,226,0.25); }
    .inputRow { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; align-items: center; padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 6px); }
    .inputRow input { flex: 1 1 200px; min-width: 140px; }
    .send { padding: 12px 16px; background: linear-gradient(135deg, #3b6ee6 0%, #2c5ac7 100%); color: #fff; border: none; border-radius: 12px; font-weight: 600; letter-spacing: .2px; transition: opacity .15s ease, transform .02s ease, box-shadow .15s ease; box-shadow: 0 6px 16px rgba(74,144,226,.25); flex: 0 0 auto; white-space: nowrap; min-width: 68px; }
    .send:active { transform: scale(0.98); }
    .footer { text-align: center; color: #9aa8c9; font-size: 13px; padding: 12px; }
    .hidden { display: none; }
    .bubble.bot ul { margin: 6px 0 0 18px; padding: 0; }
    .bubble.bot li { margin: 6px 0; }
    .optionsBubble .title { font-weight: 600; margin-bottom: 8px; color: #cfe0ff; }
    .optionBtn { width: 100%; text-align: left; background: #2a3856; color: #dbe6ff; border: 1px solid #34415f; border-radius: 16px; padding: 12px 14px; margin: 8px 0; font-size: 14px; transition: background .15s ease, box-shadow .15s ease; }
    .optionBtn:hover { background: #334466; box-shadow: 0 0 0 2px rgba(74,144,226,0.25); }
    .chip { display: inline-block; padding: 6px 10px; border-radius: 999px; font-size: 12px; }
    .offersList { display: flex; flex-direction: column; gap: 12px; margin-bottom: 12px; }
    .offerItem { display: flex; align-items: center; gap: 12px; background: #12192b; border: 1px solid #253047; border-radius: 18px; padding: 14px 16px; transition: box-shadow .15s ease, border-color .15s ease, transform .06s ease; }
    .offerItem:hover { box-shadow: 0 0 0 2px rgba(74,144,226,0.22); transform: translateY(-1px); }
    .offerItem.selected { border-color: #4a90e2; box-shadow: 0 0 0 2px rgba(74,144,226,.28); }
    .offerItem .icon { width: 44px; height: 44px; border-radius: 10px; overflow: hidden; background: #1b2438; }
    .offerItem .icon img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .offerItem .titleTxt { flex: 1; font-weight: 600; color: #e6edf7; }
    .chip.ongoing { background: #ffefb3; color: #7a5c00; }
    .chip.expired { background: #f7b9b9; color: #5a1010; }
    .chip.completed { background: #b9f1cb; color: #0e6a2a; }
    .videoOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .videoOverlay.show { display: flex; }
    .videoBox { width: 100%; max-width: 440px; background: #000; border-radius: 16px; padding: 8px; position: relative; padding-bottom: 96px; }
    .videoBox video { width: 100%; height: auto; border-radius: 8px; display: block; }
    .videoFooter { position: absolute; left: 8px; right: 8px; bottom: calc(env(safe-area-inset-bottom) + 12px); display: flex; justify-content: flex-end; gap: 8px; }
    .videoCloseTop { position: absolute; top: calc(env(safe-area-inset-top) + 12px); right: 12px; width: 44px; height: 44px; border-radius: 999px; background: rgba(0,0,0,0.6); color: #fff; border: none; font-size: 22px; display: flex; align-items: center; justify-content: center; z-index: 1002; box-shadow: 0 6px 16px rgba(0,0,0,0.25); }
    .emptyState { min-height: 220px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; color: #e6edf7; }
    .emptyIcon { font-size: 28px; }
    .emptyTitle { font-weight: 700; }
    .emptyDesc { font-size: 14px; color: #9aa8c9; max-width: 320px; text-align: center; }
    .chatEnded { display: inline-block; margin: 16px auto 4px; padding: 10px 14px; border-radius: 999px; background: #2a3856; color: #9aa8c9; border: 1px solid #34415f; }
  </style>
</head>
<body>

  <div class="app">
    <div class="header">
      <div class="avatar"><img id="offerIcon" alt="Offer icon"></div>
      <div class="title">
        <div class="name" id="offerName">Support</div>
        <div class="badge hidden" id="offerBadge"></div>
      </div>
    </div>
    <div class="content">
      <div class="controls">
        <select id="offer">
          <option value="">Select Offer</option>
          <option value="925599">WoodBlock Puzzle Game</option>
          <option value="111222">Sea Block</option>
          <option value="333444">Carrom Pool: Disc Game</option>
        </select>
      </div>
      <div id="offersList" class="offersList"></div>
      <div class="chat" id="chatLog"></div>
      <div class="suggest hidden" id="suggestRow">
        <button id="btnNotAble">I'm not able to complete the offer</button>
      </div>
      <div class="inputRow hidden" id="inputRow">
        <input id="msg" placeholder="Type your query" />
        <button class="send" id="sendBtn">Send</button>
        <button class="send" id="endBtn">End</button>
      </div>
    </div>
    <div class="footer hidden" id="footerText">Select an option above to continue</div>
  </div>
  <div id="videoOverlay" class="videoOverlay">
    <div class="videoBox">
      <button id="closeVideoTop" class="videoCloseTop" aria-label="Close">√ó</button>
      <video id="guideVideo" controls playsinline preload="metadata"></video>
      <div class="videoFooter">
        <button class="send" id="closeVideoBtn">Close</button>
      </div>
    </div>
  </div>

  <script>
    let ws;
    const chatLog = document.getElementById("chatLog");
    const msgInput = document.getElementById("msg");
    const sendBtn = document.getElementById("sendBtn");
    const endBtn = document.getElementById("endBtn");
    const inputRow = document.getElementById("inputRow");
    const offerSelect = document.getElementById("offer");
    const offerName = document.getElementById("offerName");
    const offerBadge = document.getElementById("offerBadge");
    const offerIcon = document.getElementById("offerIcon");
    const btnNotAble = document.getElementById("btnNotAble");
    const suggestRow = document.getElementById("suggestRow");
    const footerText = document.getElementById("footerText");
    let typingEl = null;
    let currentBotBubble = null;
    const statusById = { "925599": "Completed", "111222": "Ongoing", "333444": "Expired" };
    const badgeClassByStatus = { "Completed": "completed", "Ongoing": "ongoing", "Expired": "expired" };
    const iconById = { "925599": "icons/woodblock.png", "111222": "icons/aquastar.png", "333444": "icons/carrom.png" };
    const offersList = document.getElementById("offersList");
    const videoOverlay = document.getElementById("videoOverlay");
    const guideVideo = document.getElementById("guideVideo");
    const closeVideoBtn = document.getElementById("closeVideoBtn");
    const closeVideoTop = document.getElementById("closeVideoTop");
    const guideById = { "925599": "videos/tutorial.mp4", "111222": "videos/tutorial.mp4", "333444": "videos/tutorial.mp4" };
    const LLM_ENABLED = new URLSearchParams(location.search).get("llm") === "1";
    const WS_HOST_PARAM = new URLSearchParams(location.search).get("wsHost");
    const ISSUE_TYPE_PARAM = new URLSearchParams(location.search).get("issueType");
    const qpAll = new URLSearchParams(location.search);
    const JUST_CHAT_MODE = (
      LLM_ENABLED &&
      (!qpAll.get("offerId") || !qpAll.get("offerName") || !qpAll.get("offerIconUrl") || !qpAll.get("userId"))
    );
    let pendingInitialMsg = null;
    let pendingStartTyping = false;
    let chatEnded = false;

    function setOfferFromData({ offerId, offerName, offerIconUrl, status }) {
      if (!offerId) return;
      const label = offerName || "Offer";
      statusById[offerId] = status || "Ongoing";
      if (offerIconUrl) iconById[offerId] = offerIconUrl;
      offerSelect.innerHTML = `<option value="">Select Offer</option><option value="${offerId}">${label}</option>`;
      renderOffersList();
      highlightSelectedOffer();
      if (!offerSelect.value) { renderEmptyState(); }
    }
    function applyOfferFromParams() {
      const qp = new URLSearchParams(location.search);
      const offerId = qp.get("offerId");
      const offerName = qp.get("offerName");
      const offerIconUrl = qp.get("offerIconUrl");
      const status = qp.get("status") || "Ongoing";
      if (!offerId) return;
      setOfferFromData({ offerId, offerName, offerIconUrl, status });
    }
    window.addEventListener("popstate", applyOfferFromParams);
    window.addEventListener("hashchange", applyOfferFromParams);
    window.addEventListener("message", (e) => {
      const d = e.data;
      if (d && d.type === "setOffer" && d.payload) setOfferFromData(d.payload);
    });

    function placeholderIcon(title) {
      const letter = (title || "S").trim().charAt(0).toUpperCase() || "S";
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><rect width='100%' height='100%' fill='#e5eefc'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-size='18' fill='#193b7a' font-family='Segoe UI, Roboto, Arial'>${letter}</text></svg>`;
      return "data:image/svg+xml;utf8," + encodeURIComponent(svg);
    }
    function aiSupportIcon() {
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='#1460f2'/><stop offset='100%' stop-color='#4a90e2'/></linearGradient></defs><rect rx='8' width='40' height='40' fill='url(#g)'/><g fill='#fff'><circle cx='20' cy='16' r='6'/><rect x='11' y='23' width='18' height='8' rx='4'/><circle cx='17' cy='16' r='1.5'/><circle cx='23' cy='16' r='1.5'/></g></svg>`;
      return "data:image/svg+xml;utf8," + encodeURIComponent(svg);
    }

    function updateOfferIcon() {
      offerIcon.src = aiSupportIcon();
      offerIcon.onerror = () => { offerIcon.src = aiSupportIcon(); };
    }

    function addBubble(text, who) {
      const b = document.createElement("div");
      b.className = "bubble " + who;
      b.textContent = text;
      chatLog.appendChild(b);
      chatLog.scrollTop = chatLog.scrollHeight;
      return b;
    }
    function addBubbleHTML(html, who) {
      const b = document.createElement("div");
      b.className = "bubble " + who;
      b.innerHTML = html;
      chatLog.appendChild(b);
      chatLog.scrollTop = chatLog.scrollHeight;
      return b;
    }
    function showTypingIndicator() {
      if (typingEl) return;
      if (!currentBotBubble) {
        // Create a temporary bubble reserved for typing; remove if no text arrives
        currentBotBubble = addBubble("", "bot");
        currentBotBubble.setAttribute("data-typing-only", "1");
      }
      typingEl = document.createElement("span");
      typingEl.className = "typing";
      typingEl.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      currentBotBubble.appendChild(typingEl);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
    function hideTypingIndicator() {
      if (typingEl) { typingEl.remove(); typingEl = null; }
    }

    function connect() {
      const isHttps = location.protocol === "https:";
      const defaultHost = isHttps ? location.host : "localhost:8000";
      const host = WS_HOST_PARAM || defaultHost;
      const useSecure = isHttps || (WS_HOST_PARAM && !/^localhost(:\d+)?$/.test(host));
      const url = (useSecure ? "wss://" : "ws://") + host + "/ws";
      ws = new WebSocket(url);
      ws.onopen = () => {
        // Connected: clear status and enable send
        footerText.classList.add("hidden");
        sendBtn.disabled = false;
        if (pendingStartTyping) {
          pendingStartTyping = false;
          try { ws.send(JSON.stringify({ event: "start_typing" })); } catch (e) {}
        }
        if (pendingInitialMsg) {
          const m = pendingInitialMsg;
          pendingInitialMsg = null;
          addBubble(m, "user");
          currentBotBubble = null;
          showTypingIndicator();
          try { ws.send(JSON.stringify({ message: m, offer_id: "" })); } catch (e) {}
        }
      };
      ws.onmessage = (event) => {
        if (!currentBotBubble) currentBotBubble = addBubble("", "bot");
        if (event.data === "\n\n") {
          hideTypingIndicator();
          // If nothing was written and this was a typing-only bubble, remove it
          if (currentBotBubble && currentBotBubble.getAttribute("data-typing-only") === "1" &&
              (currentBotBubble.textContent || "").trim() === "") {
            currentBotBubble.remove();
          }
          currentBotBubble = null;
          return;
        }
        hideTypingIndicator();
        currentBotBubble.removeAttribute("data-typing-only");
        currentBotBubble.textContent += event.data;
        chatLog.scrollTop = chatLog.scrollHeight;
      };
      ws.onclose = () => {
        hideTypingIndicator();
        if (currentBotBubble && currentBotBubble.getAttribute("data-typing-only") === "1" &&
            (currentBotBubble.textContent || "").trim() === "") {
          currentBotBubble.remove();
          currentBotBubble = null;
        }
        if (!chatEnded) {
          footerText.textContent = "Reconnecting‚Ä¶";
          footerText.classList.remove("hidden");
          sendBtn.disabled = true;
          setTimeout(connect, 3000);
        }
      };
      ws.onerror = () => {
        hideTypingIndicator();
        if (currentBotBubble && currentBotBubble.getAttribute("data-typing-only") === "1" &&
            (currentBotBubble.textContent || "").trim() === "") {
          currentBotBubble.remove();
          currentBotBubble = null;
        }
        if (!chatEnded) {
          footerText.textContent = "Reconnecting‚Ä¶";
          footerText.classList.remove("hidden");
          sendBtn.disabled = true;
        }
      };
    }
    offerIcon.src = aiSupportIcon();
    applyOfferFromParams();
    renderOffersList();
    if (JUST_CHAT_MODE) {
      document.querySelector(".controls").style.display = "none";
      document.getElementById("offersList").style.display = "none";
      offerName.textContent = "Chat Support";
      offerBadge.textContent = "";
      offerBadge.className = "badge hidden";
      chatLog.innerHTML = "";
      if (LLM_ENABLED) { try { connect(); } catch (e) {} }
      showTypeIssue();
      if (ISSUE_TYPE_PARAM) {
        const m = `I need help with ${ISSUE_TYPE_PARAM}.`;
        pendingInitialMsg = m;
        if (ws && ws.readyState === WebSocket.OPEN) {
          const tmp = pendingInitialMsg;
          pendingInitialMsg = null;
          addBubble(tmp, "user");
          currentBotBubble = addBubble("", "bot");
          showTypingIndicator();
          try { ws.send(JSON.stringify({ message: tmp, offer_id: "" })); } catch (e) {}
        }
      }
    } else {
      if (!offerSelect.value) renderEmptyState();
      if (LLM_ENABLED) { try { connect(); } catch (e) {} }
    }

    offerSelect.addEventListener("change", () => {
      chatLog.innerHTML = "";
      msgInput.value = "";
      inputRow.classList.add("hidden");
      suggestRow.classList.add("hidden");
      footerText.classList.add("hidden");
      hideTypingIndicator();
      const title = offerSelect.options[offerSelect.selectedIndex]?.text || "Support";
      offerName.textContent = title;
      updateOfferIcon();
      if (!offerSelect.value) {
        offerBadge.textContent = "";
        offerBadge.className = "badge hidden";
        renderEmptyState();
      } else {
        const status = statusById[offerSelect.value] || "Ongoing";
        offerBadge.textContent = status;
        offerBadge.className = "badge " + (badgeClassByStatus[status] || "ongoing");
        // Suggestions are rendered inside chat bubbles; keep external row hidden
        // Default guided messages per status
        if (status === "Ongoing") {
          addBubble("I see that you've started this offer! üéØ", "bot");
          addBubble("Advertisers typically take 24‚Äì48 hours to verify your task and process rewards. Please continue using the app/game for 20‚Äì30 minutes. üéÆ", "bot");
        } else if (status === "Completed") {
          addBubble("Your offer is already completed. Please check your wallet.", "bot");
          addBubble("You can explore other available offers.", "bot");
        } else if (status === "Expired") {
          addBubble("This offer has expired.", "bot");
          addBubble("You can try other available offers.", "bot");
        }
        // Set options per status
        setOptionsForStatus(status);
      }
      updateFooterVisibility();
      highlightSelectedOffer();
    });

    function updateFooterVisibility() { footerText.classList.add("hidden"); }
    function renderEmptyState() {
      chatLog.innerHTML = "";
      const wrap = document.createElement("div");
      wrap.className = "emptyState";
      const icon = document.createElement("div");
      icon.className = "emptyIcon";
      icon.textContent = "üß©";
      const title = document.createElement("div");
      title.className = "emptyTitle";
      title.textContent = "Select an offer to get help";
      const desc = document.createElement("div");
      desc.className = "emptyDesc";
      desc.textContent = "Choose an offer above to see quick steps and a short video guide.";
      wrap.appendChild(icon);
      wrap.appendChild(title);
      wrap.appendChild(desc);
      chatLog.appendChild(wrap);
    }

    let currentOptionsContainer = null;
    function setSuggestions(items, title = "What would you like to know?") {
      if (currentOptionsContainer) { currentOptionsContainer.remove(); currentOptionsContainer = null; }
      if (!items || items.length === 0) { updateFooterVisibility(); return; }
      const wrap = document.createElement("div");
      wrap.className = "optionsBubble";
      const inner = document.createElement("div");
      inner.className = "bubble bot";
      const heading = document.createElement("div");
      heading.className = "title";
      heading.textContent = title;
      inner.appendChild(heading);
      items.forEach(({ text, onClick }) => {
        const btn = document.createElement("button");
        btn.className = "optionBtn";
        btn.textContent = text;
        btn.onclick = () => { addBubble(text, "user"); onClick(); inner.remove(); currentOptionsContainer = null; };
        inner.appendChild(btn);
      });
      wrap.appendChild(inner);
      chatLog.appendChild(wrap);
      chatLog.scrollTop = chatLog.scrollHeight;
      currentOptionsContainer = wrap;
      updateFooterVisibility();
    }

    function showHelpOptions() {
      addBubble("Let‚Äôs get you back on track. Choose an option:", "bot");
      setSuggestions([
        { text: "Watch 2‚Äëmin guide", onClick: showWatchGuide },
        { text: "View step‚Äëby‚Äëstep instructions", onClick: showStepByStep },
        { text: "I‚Äôd rather type out my issue", onClick: showTypeIssue }
      ]);
    }

    function showWatchGuide() {
      addBubble("Watch a short guide to complete the offer üéØ", "bot");
      const btn = document.createElement("button");
      btn.className = "send";
      btn.textContent = "Watch now";
      btn.onclick = () => {
        const current = offerSelect.value;
        const src = guideById[current] || "videos/tutorial.mp4";
        openGuideVideo(src);
        endChat();
      };
      const holder = document.createElement("div");
      holder.style.marginTop = "8px";
      holder.appendChild(btn);
      chatLog.appendChild(holder);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function showStepByStep() {
      addBubble("Step‚Äëby‚Äëstep Instructions:", "bot");
      addBubbleHTML("<ul><li>Install the app</li><li>Use for 10+ minutes ‚è≥</li><li>Sign up with valid details üìù</li><li>Don‚Äôt uninstall üö´</li></ul>", "bot");
      setSuggestions([
        { text: "Check out other available offers", onClick: showBrowseOffers },
        { text: "Report this issue to us", onClick: showReportIssue }
      ]);
    }

    function renderOffersList() {
      offersList.innerHTML = "";
      Array.from(offerSelect.options).forEach(o => {
        if (!o.value) return;
        const item = document.createElement("div");
        item.className = "offerItem";
        const iconWrap = document.createElement("div");
        iconWrap.className = "icon";
        const img = document.createElement("img");
        img.src = iconById[o.value] || placeholderIcon(o.text);
        img.onerror = () => { img.src = placeholderIcon(o.text); };
        iconWrap.appendChild(img);
        const title = document.createElement("div");
        title.className = "titleTxt";
        title.textContent = o.text;
        const status = statusById[o.value] || "Ongoing";
        const chip = document.createElement("div");
        chip.className = "chip " + (badgeClassByStatus[status] || "ongoing");
        chip.textContent = status;
        item.appendChild(iconWrap);
        item.appendChild(title);
        item.appendChild(chip);
        item.onclick = () => {
          offerSelect.value = o.value;
          offerSelect.dispatchEvent(new Event("change"));
        };
        offersList.appendChild(item);
      });
      highlightSelectedOffer();
    }
    function highlightSelectedOffer() {
      Array.from(offersList.children).forEach(child => child.classList.remove("selected"));
      const val = offerSelect.value;
      if (!val) return;
      const idx = Array.from(offerSelect.options).findIndex(o => o.value === val);
      if (idx > -1) {
        const el = offersList.children[idx - 1]; // skip the first 'Select Offer' option
        if (el) el.classList.add("selected");
      }
    }
    function showBrowseOffers() {
      addBubble("Navigate to offers screen to check other available offers", "bot");
      endChat();
    }

    function showReportIssue() {
      const title = offerSelect.options[offerSelect.selectedIndex]?.text || "Offer";
      const offerId = offerSelect.value || "";
      const subject = encodeURIComponent(`Issue with offer ${title}${offerId ? ` (${offerId})` : ""}`);
      const body = encodeURIComponent("Describe your issue briefly, including screenshots if possible.");
      const mailto = `mailto:support@greedygame.com?subject=${subject}&body=${body}`;
      addBubble("Redirecting to support@greedygame.com for assistance.", "bot");
      const link = document.createElement("a");
      link.href = mailto;
      link.textContent = "Open email";
      link.className = "send";
      link.target = "_blank";
      const holder = document.createElement("div");
      holder.style.marginTop = "8px";
      holder.appendChild(link);
      chatLog.appendChild(holder);
      chatLog.scrollTop = chatLog.scrollHeight;
      window.location.href = mailto;
      setSuggestions([
        { text: "Try other available offers", onClick: showBrowseOffers },
        { text: "End Chat", onClick: endChat }
      ]);
    }

    function endChat() {
      chatEnded = true;
      addBubble("Happy earning with Sikka! üí∞üöÄ", "bot");
      const pill = document.createElement("div");
      pill.className = "chatEnded";
      pill.textContent = "The chat has been ended";
      const holder = document.createElement("div");
      holder.style.display = "flex";
      holder.style.justifyContent = "center";
      holder.appendChild(pill);
      chatLog.appendChild(holder);
      setSuggestions([]);
      inputRow.classList.add("hidden");
      try {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ event: "end_chat" }));
          try { ws.close(1000, "ended"); } catch (e) {}
        }
      } catch (e) {}
    }
    function getMimeType(src) {
      const ext = (src.split(".").pop() || "").toLowerCase();
      if (ext === "mp4") return "video/mp4";
      if (ext === "webm") return "video/webm";
      if (ext === "mov") return "video/quicktime";
      return "video/mp4";
    }
    function openGuideVideo(src) {
      guideVideo.innerHTML = "";
      const source = document.createElement("source");
      source.src = src;
      source.type = getMimeType(src);
      guideVideo.appendChild(source);
      videoOverlay.classList.add("show");
      guideVideo.load();
      guideVideo.onloadedmetadata = () => {
        guideVideo.play().catch(() => {});
      };
      guideVideo.onerror = () => {
        closeGuideVideo();
        addBubble("Unable to load video. Opening in a new tab‚Ä¶", "bot");
        try { window.open(src, "_blank"); } catch (e) {}
      };
      guideVideo.onended = () => {
        closeGuideVideo();
        endChat();
      };
    }
    function closeGuideVideo() {
      guideVideo.pause();
      guideVideo.currentTime = 0;
      guideVideo.innerHTML = "";
      videoOverlay.classList.remove("show");
    }
    closeVideoBtn.onclick = closeGuideVideo;
    closeVideoTop.onclick = closeGuideVideo;

    function setOptionsForStatus(status) {
      if (status === "Ongoing") {
        setSuggestions([
          { text: "I'm not able to complete the offer", onClick: showHelpOptions },
          { text: "I‚Äôd rather type out my issue", onClick: showTypeIssue }
        ]);
      } else if (status === "Completed") {
        setSuggestions([
          { text: "Check out other available offers", onClick: showBrowseOffers },
          { text: "I‚Äôd rather type out my issue", onClick: showTypeIssue }
        ]);
      } else if (status === "Expired") {
        setSuggestions([
          { text: "Check out other available offers", onClick: showBrowseOffers },
          { text: "I‚Äôd rather type out my issue", onClick: showTypeIssue }
        ]);
      }
    }
    // Initialize with hidden (no offer selected); options appear after selection via setOptionsForStatus()
    sendBtn.addEventListener("click", send);
    msgInput.addEventListener("keydown", (e) => { if (e.key === "Enter") send(); });

    function send() {
      const msg = msgInput.value.trim();
      const offer = offerSelect.value;
      if (!msg) return;
      addBubble(msg, "user");
      currentBotBubble = null;
      pendingInitialMsg = msg;
      showTypingIndicator();
      msgInput.value = "";
      if (ws && ws.readyState === WebSocket.OPEN) {
        try { ws.send(JSON.stringify({ message: msg, offer_id: offer })); } catch (e) {}
        pendingInitialMsg = null;
      } else {
        try { connect(); } catch (e) {}
      }
    }

    function showTypeIssue() {
      addBubble("Type your message below.", "bot");
      if (LLM_ENABLED && (!ws || ws.readyState !== WebSocket.OPEN)) {
        try { connect(); } catch (e) {}
      }
      if (LLM_ENABLED) {
        if (ws && ws.readyState === WebSocket.OPEN) {
          try { ws.send(JSON.stringify({ event: "start_typing" })); } catch (e) {}
        } else {
          pendingStartTyping = true;
        }
      }
      inputRow.classList.remove("hidden");
      msgInput.focus();
    }
    endBtn.onclick = () => { endChat(); };
  </script>

</body>
</html>
